<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="face-test-title"></title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            padding-top: 20px;
            text-align: center;
        }
        #label-container {
            margin-top: 20px;
            font-size: 1.2em;
        }
        #label-container div {
            margin-bottom: 5px;
            padding: 5px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        #image-container {
            margin-top: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #image-canvas {
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            font-size: 1.2em;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #back-to-home {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            font-size: 1em;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
        }
        #back-to-home:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>
    <a href="index.html" id="back-to-home"></a>
    <h1 id="face-test-header"></h1>
    <div id="tm-image-model-text"></div>
    <button type="button" id="face-test-start-button"></button>
    <input type="file" id="file-input" accept="image/*" style="display: none;">
    <div id="image-container">
        <canvas id="image-canvas" style="display: none; max-width: 200px; max-height: 200px;"></canvas>
    </div>
    <div id="label-container"></div>
    <div id="face-description" style="margin-top: 20px; font-size: 1.1em; color: #555;"></div>
    <button id="share-face-button" style="display: none; margin-top: 20px;" class="lang-button"></button>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script type="text/javascript">
        // More API functions here:
        // https://github.com/googlecreativelab/teachablemachine-community/tree/master/libraries/image

        // the link to your model provided by Teachable Machine export panel
        const URL = "https://teachablemachine.withgoogle.com/models/BqpR6ZHhi/";

        let model, labelContainer, maxPredictions;
        const imageCanvas = document.getElementById('image-canvas');
        const fileInput = document.getElementById('file-input');
        const startButton = document.getElementById('face-test-start-button');
        const faceDescriptionDiv = document.getElementById('face-description');
        const shareFaceButton = document.getElementById('share-face-button'); // Get button reference
        let ctx = imageCanvas.getContext('2d');
        let translations; // Declare translations in a higher scope
        let lastPredictedResult = { className: '', description: '' }; // To store the last prediction
        
        // Confetti setup - use the image-container as the origin for confetti
        const myConfetti = confetti.create(document.getElementById('image-container'), {
            resize: true,
            useWorker: true
        });

        // Load the image model
        async function loadModel() {
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";
            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();
        }

        // Function to predict from an image
        async function predict() {
            if (!model) {
                console.error("Model not loaded.");
                return;
            }
            const prediction = await model.predict(imageCanvas);
            let highestProbability = 0;
            let predictedClassName = '';

            for (let i = 0; i < maxPredictions; i++) {
                if (prediction[i].probability > highestProbability) {
                    highestProbability = prediction[i].probability;
                    predictedClassName = prediction[i].className;
                }
            }
            
            // Clear previous predictions (if any) and set only the highest one
            labelContainer.innerHTML = '';
            const resultDiv = document.createElement("div");
            resultDiv.innerHTML = predictedClassName; // Only show the class name, not probability
            labelContainer.appendChild(resultDiv);

            // Get current language and descriptions from the translations object
            const currentLang = localStorage.getItem('lang') || 'ko';
            const description = translations[currentLang].faceDescriptions[predictedClassName];
            faceDescriptionDiv.textContent = description || ''; // Display the description or empty string
            
            lastPredictedResult = { className: predictedClassName, description: description }; // Store result
            shareFaceButton.style.display = 'block'; // Show share button after prediction

            // Trigger confetti for "상" class
            if (predictedClassName === '상') {
                myConfetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }
        }

        startButton.addEventListener('click', () => {
            fileInput.click(); // Trigger the file input click
        });

        fileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }
            const reader = new FileReader();
            reader.onload = async (e) => {
                const img = new Image();
                img.onload = async () => {
                    // Resize image to 200x200 for the model
                    imageCanvas.width = 200;
                    imageCanvas.height = 200;
                    ctx.drawImage(img, 0, 0, 200, 200);
                    imageCanvas.style.display = 'block'; // Show the canvas
                    labelContainer.innerHTML = ''; // Clear previous predictions
                    faceDescriptionDiv.textContent = ''; // Clear previous description
                    shareFaceButton.style.display = 'none'; // Hide share button until new prediction
                    await predict();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });

        shareFaceButton.addEventListener('click', () => {
            const currentLang = localStorage.getItem('lang') || 'ko';
            const shareTextTemplate = translations[currentLang].shareFaceText;
            const shareText = shareTextTemplate
                .replace('##RESULT##', lastPredictedResult.className)
                .replace('##DESCRIPTION##', lastPredictedResult.description);
            const shareUrl = 'https://www.instagram.com/'; // Placeholder for Instagram share

            alert(`인스타그램에 공유해보세요!\n\n${shareText}`);
            window.open(shareUrl, '_blank');
        });

        // Initialize on DOMContentLoaded to load model and setup UI
        document.addEventListener('DOMContentLoaded', async () => {
            await loadModel();
            labelContainer = document.getElementById("label-container");
            // Define translations locally for initialization
            const localTranslations = {
                ko: {
                    faceTestTitle: '관상 테스트',
                    backToHome: '홈으로 돌아가기',
                    tmImageModel: 'Teachable Machine Image Model',
                    start: '이미지 업로드',
                    faceDescriptions: {
                        '상': '당신은 타고난 복을 지닌 관상입니다! 넓은 이마와 또렷한 눈빛은 지혜와 통찰력을, 두툼한 귓볼은 재물운을 상징합니다. 또한, 입꼬리가 살짝 올라가 있어 인덕이 많고 주변 사람들에게 행운을 가져다주는 길상입니다. 하는 일마다 술술 풀리고 사람들의 존경을 받는 리더의 상입니다. 앞으로 펼쳐질 성공적인 삶을 기대해도 좋습니다!',
                        '중': '당신은 안정적이고 균형 잡힌 관상입니다! 단정하고 깔끔한 인상은 신뢰감을 주며, 부드러운 눈매는 온화한 성품을 나타냅니다. 코의 형태가 안정적이어서 재물운도 꾸준히 들어오는 편입니다. 큰 굴곡 없이 평탄하고 행복한 삶을 꾸려나갈 관상으로, 꾸준한 노력으로 더욱 발전할 수 있습니다. 작은 행운들이 당신을 기다리고 있습니다!',
                        '하': '당신은 개성 넘치는 매력적인 관상입니다! 날카로운 눈매는 강한 추진력을, 개성 있는 코는 특별한 재능을 의미합니다. 때로는 고집이 세다는 인상을 줄 수 있지만, 이는 목표를 향한 강한 의지를 나타냅니다. 남들과는 다른 특별한 길을 개척하여 성공할 수 있는 관상입니다. 당신만의 독특한 매력으로 주변을 사로잡을 수 있습니다. 스스로를 믿고 나아가세요!'
                    },
                    shareFaceButton: '결과 공유하기',
                    shareFaceText: '방금 관상 테스트에서 "##RESULT##" 관상으로 나왔어요! ##DESCRIPTION##'
                },
                en: {
                    faceTestTitle: 'Face Test',
                    backToHome: 'Back to Home',
                    tmImageModel: 'Teachable Machine Image Model',
                    start: 'Upload Image',
                    faceDescriptions: {
                        '상': 'You possess a face of innate prosperity! A broad forehead and clear eyes symbolize wisdom and insight, while thick earlobes indicate wealth. Your gently upturned mouth corners suggest great personal charm, bringing luck to those around you. This is the mark of a respected leader who finds smooth success in all endeavors. Look forward to a successful life ahead!',
                        '중': 'Yours is a balanced and stable face! Your neat and tidy appearance inspires trust, and soft eyes reveal a gentle nature. A steady nose shape indicates consistent financial fortune. This face suggests a smooth and happy life without major upheavals; continuous effort will bring further development. Small fortunes are awaiting you!',
                        '하': 'You have a face of distinctive charm! Sharp eyes signify strong drive, and a unique nose suggests special talents. While sometimes perceived as stubborn, this reflects your strong will towards your goals. This face is destined to forge a unique path to success, captivating others with your individual charisma. Trust yourself and move forward!'
                    },
                    shareFaceButton: 'Share Result',
                    shareFaceText: 'My face reading test result is "##RESULT##"! ##DESCRIPTION##'
                }
            };
            translations = localTranslations; // Assign to higher scope variable

            // Initial language setup
            const currentLang = localStorage.getItem('lang') || 'ko';
            document.title = translations[currentLang].faceTestTitle;
            document.getElementById('face-test-header').textContent = translations[currentLang].faceTestTitle;
            document.getElementById('back-to-home').textContent = translations[currentLang].backToHome;
            document.getElementById('tm-image-model-text').textContent = translations[currentLang].tmImageModel;
            document.getElementById('face-test-start-button').textContent = translations[currentLang].start;
            shareFaceButton.textContent = translations[currentLang].shareFaceButton; // Set text for share button
        });
    </script>
</body>