<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="animal-face-test-title"></title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            padding-top: 20px;
            text-align: center;
        }
        #label-container {
            margin-top: 20px;
            font-size: 1.2em;
        }
        #label-container div {
            margin-bottom: 5px;
            padding: 5px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        #image-container {
            margin-top: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #image-canvas {
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            font-size: 1.2em;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #back-to-home {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            font-size: 1em;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
        }
        #back-to-home:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>
    <a href="index.html" id="back-to-home"></a>
    <h1 id="animal-face-test-header"></h1>
    <div id="tm-image-model-text"></div>
    <button type="button" id="animal-face-test-start-button"></button>
    <input type="file" id="file-input" accept="image/*" style="display: none;">
    <div id="image-container">
        <canvas id="image-canvas" style="display: none; max-width: 200px; max-height: 200px;"></canvas>
    </div>
    <div id="label-container"></div>
    <div id="animal-description" style="margin-top: 20px; font-size: 1.1em; color: #555;"></div>
    <button id="share-animal-face-button" style="display: none; margin-top: 20px;" class="lang-button"></button>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script type="text/javascript">
        // More API functions here:
        // https://github.com/googlecreativelab/teachablemachine-community/tree/master/libraries/image

        // THE TEAHABLE MACHINE MODEL URL FOR ANIMAL FACE TEST
        // PLEASE REPLACE THIS WITH YOUR ACTUAL MODEL URL
        const URL = "https://teachablemachine.withgoogle.com/models/ANIMAL_MODEL_PLACEHOLDER/"; 

        let model, labelContainer, maxPredictions;
        const imageCanvas = document.getElementById('image-canvas');
        const fileInput = document.getElementById('file-input');
        const startButton = document.getElementById('animal-face-test-start-button');
        const animalDescriptionDiv = document.getElementById('animal-description');
        const shareAnimalFaceButton = document.getElementById('share-animal-face-button'); 
        let ctx = imageCanvas.getContext('2d');
        let translations; // Declare translations in a higher scope
        let lastPredictedResult = { originalClassName: '', translatedClassName: '', description: '' };
        
        // Confetti setup - use the image-container as the origin for confetti
        const myConfetti = confetti.create(document.getElementById('image-container'), {
            resize: true,
            useWorker: true
        });

        // Load the image model
        async function loadModel() {
            try {
                const modelURL = URL + "model.json";
                const metadataURL = URL + "metadata.json";
                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();
            } catch (error) {
                console.error("Failed to load Teachable Machine model:", error);
                alert("Teachable Machine 모델을 로드하는 데 실패했습니다. 네트워크 연결을 확인하거나 나중에 다시 시도해 주세요."); // User-friendly error message
            }
        }

        // Function to predict from an image
        async function predict() {
            if (!model) {
                console.error("Model not loaded.");
                return;
            }
            const prediction = await model.predict(imageCanvas);
            let highestProbability = 0;
            let originalPredictedClassName = '';

            for (let i = 0; i < maxPredictions; i++) {
                if (prediction[i].probability > highestProbability) {
                    highestProbability = prediction[i].probability;
                    originalPredictedClassName = prediction[i].className;
                }
            }
            
            // Get current language and translations
            const currentLang = localStorage.getItem('lang') || 'ko';
            const translatedClassName = translations[currentLang].animalClassTranslations[originalPredictedClassName] || originalPredictedClassName;
            const description = translations[currentLang].animalDescriptions[translatedClassName];

            labelContainer.innerHTML = '';
            const resultDiv = document.createElement("div");
            resultDiv.innerHTML = translatedClassName;
            labelContainer.appendChild(resultDiv);

            animalDescriptionDiv.textContent = description || '';
            
            lastPredictedResult = { 
                originalClassName: originalPredictedClassName,
                translatedClassName: translatedClassName,
                description: description 
            };
            shareAnimalFaceButton.style.display = 'block';

            // Trigger confetti for "개상" (dog face)
            if (originalPredictedClassName === 'Dog') { // Assuming 'Dog' is the class name for 개상
                myConfetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }
        }

        startButton.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }
            const reader = new FileReader();
            reader.onload = async (e) => {
                const img = new Image();
                img.onload = async () => {
                    imageCanvas.width = 200;
                    imageCanvas.height = 200;
                    ctx.drawImage(img, 0, 0, 200, 200);
                    imageCanvas.style.display = 'block';
                    labelContainer.innerHTML = '';
                    animalDescriptionDiv.textContent = '';
                    shareAnimalFaceButton.style.display = 'none';
                    await predict();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });

        shareAnimalFaceButton.addEventListener('click', () => {
            const currentLang = localStorage.getItem('lang') || 'ko';
            const shareTextTemplate = translations[currentLang].shareAnimalFaceText;
            const shareText = shareTextTemplate
                .replace('##RESULT##', lastPredictedResult.translatedClassName)
                .replace('##DESCRIPTION##', lastPredictedResult.description);
            const shareUrl = 'https://www.instagram.com/';

            alert(`인스타그램에 공유해보세요!

${shareText}`);
            window.open(shareUrl, '_blank');
        });

        document.addEventListener('DOMContentLoaded', async () => {
            await loadModel();
            labelContainer = document.getElementById("label-container");
            const localTranslations = {
                ko: {
                    animalFaceTestTitle: '동물상 테스트',
                    backToHome: '홈으로 돌아가기',
                    tmImageModel: 'Teachable Machine Image Model',
                    start: '이미지 업로드',
                    animalDescriptions: {
                        '개상': '당신은 충성스럽고 정이 많은 개상입니다! 크고 맑은 눈은 순수함을, 살짝 처진 눈꼬리는 온화함을 나타냅니다. 주변 사람들에게 편안함을 주며, 한번 마음 준 사람은 절대 배신하지 않는 의리의 상입니다. 긍정적이고 활발한 성격으로 어디서든 인기를 한 몸에 받습니다. 당신의 매력에 모두가 빠져들 거예요!',
                        '고양이상': '당신은 도도하고 매력적인 고양이상입니다! 날카로운 듯 올라간 눈꼬리는 섹시함을, 오똑한 콧대는 자신감을 보여줍니다. 신비로운 분위기로 사람들의 시선을 사로잡으며, 독립적이고 자기 주관이 뚜렷합니다. 때로는 까칠해 보이지만, 마음을 열면 누구보다 따뜻한 매력을 발산합니다. 당신의 시크한 매력에 많은 사람들이 반할 것입니다!',
                        '돼지상': '당신은 복스럽고 풍요로운 돼지상입니다! 둥글고 푸근한 인상은 재물운과 건강운을 동시에 상징합니다. 넉넉한 얼굴형은 사람들에게 편안함과 안정감을 주며, 먹을 복과 인복이 많아 항상 주변에 사람이 끊이지 않습니다. 낙천적이고 여유로운 성격으로 어떤 어려움도 현명하게 헤쳐나갑니다. 당신과 함께하는 모든 순간이 행복으로 가득 찰 거예요!'
                    },
                    animalClassTranslations: {
                        'Dog': '개상',
                        'Cat': '고양이상',
                        'Pig': '돼지상'
                    },
                    shareAnimalFaceButton: '결과 공유하기',
                    shareAnimalFaceText: '방금 동물상 테스트에서 "##RESULT##" 동물상으로 나왔어요! ##DESCRIPTION##'
                },
                en: {
                    animalFaceTestTitle: 'Animal Face Test',
                    backToHome: 'Back to Home',
                    tmImageModel: 'Teachable Machine Image Model',
                    start: 'Upload Image',
                    animalDescriptions: {
                        'Dog': 'You have a loyal and affectionate Dog Face! Large, clear eyes signify purity, and slightly downturned eyes indicate gentleness. You bring comfort to those around you and never betray those you've bonded with. Your positive and active personality makes you popular everywhere. Everyone will fall for your charm!',
                        'Cat': 'Yours is a haughty and charming Cat Face! Sharply upturned eyes suggest sexiness, and a high nose bridge shows confidence. You captivate attention with your mysterious aura, being independent and opinionated. Though sometimes appearing prickly, you radiate warmth once you open up. Many will be smitten by your chic charm!',
                        'Pig': 'You possess a fortunate and prosperous Pig Face! Your round and amiable features symbolize both wealth and health. Your generous face shape brings comfort and stability to others, and you are blessed with good fortune in food and relationships. Your optimistic and relaxed nature allows you to wisely navigate any difficulties. Every moment with you will be filled with happiness!'
                    },
                    animalClassTranslations: {
                        'Dog': 'Dog Face',
                        'Cat': 'Cat Face',
                        'Pig': 'Pig Face'
                    },
                    shareAnimalFaceButton: 'Share Result',
                    shareAnimalFaceText: 'My animal face reading result is "##RESULT##"! ##DESCRIPTION##'
                }
            };
            translations = localTranslations; // Assign to higher scope variable

            // Initial language setup
            const currentLang = localStorage.getItem('lang') || 'ko';
            document.title = translations[currentLang].animalFaceTestTitle;
            document.getElementById('animal-face-test-header').textContent = translations[currentLang].animalFaceTestTitle;
            document.getElementById('back-to-home').textContent = translations[currentLang].backToHome;
            document.getElementById('tm-image-model-text').textContent = translations[currentLang].tmImageModel;
            document.getElementById('animal-face-test-start-button').textContent = translations[currentLang].start;
            shareAnimalFaceButton.textContent = translations[currentLang].shareAnimalFaceButton; // Set text for share button
        });
    </script>
</body>
</html>