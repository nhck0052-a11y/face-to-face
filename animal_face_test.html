<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="google-adsense-account" content="ca-pub-7447900045188794">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7447900045188794"
     crossorigin="anonymous"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="animal-face-test-title"></title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            padding-top: 20px;
            text-align: center;
            position: relative; /* For absolute positioning of back-to-home button */
        }
        #label-container {
            margin-top: 20px;
            font-size: 1.2em;
        }
        #label-container div {
            margin-bottom: 5px;
            padding: 5px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        #image-container {
            margin-top: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #image-canvas {
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            font-size: 1.2em;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }
        button:hover {
            background-color: #0056b3;
        }
        /* back-to-home-button style will be defined in style.css */
    </style>
</head>
<body>
    <header class="site-header">
        <div class="site-header__wrapper">
            <a href="index.html" class="site-title">Face-to-Face</a>
            <nav class="nav">
                <button id="lang-ko" class="lang-button">한국어</button>
                <button id="lang-en" class="lang-button">English</button>
                <a class="nav__link" href="animal_face_test.html" id="animal-face-test-nav-button"></a>
                <a class="nav__link" href="about.html" id="about-nav-button"></a>
                <a class="nav__link" href="articles.html" id="articles-nav-button"></a>
                <button id="contact-nav-button" class="lang-button"></button>
            </nav>
        </div>
    </header>

    <main>
        <h1 id="animal-face-test-header"></h1>
        <p id="animal-face-test-description" class="site-description"></p>
        <div id="tm-image-model-text"></div>
        <button id="animal-face-test-start-button" class="lang-button" style="display: block;">
            <input type="file" id="file-input" accept="image/*" style="display: none;">
        </button>
        <div id="loading-message" style="display: none; margin-top: 20px; font-size: 1.2em; color: #555;">잠시만 기다려주세요...</div>
        <div id="image-container">
            <canvas id="image-canvas" style="display: none; max-width: 200px; max-height: 200px;"></canvas>
        </div>
        <div id="label-container"></div>
        <div id="animal-description" style="margin-top: 20px; font-size: 1.1em; color: #555;"></div>
        <button id="share-animal-face-button" style="display: none; margin-top: 20px;" class="lang-button"></button>
    </main>

    <footer class="site-footer">
        <div class="site-footer__wrapper">
            <a href="about.html" id="footer-about">About Us</a> |
            <a href="privacy.html" id="footer-privacy">Privacy Policy</a>
            <p>© 2026 Face-to-Face. All Rights Reserved.</p>
        </div>
    </footer>

    <section id="contact-section" class="contact-section">
        <div class="contact-form-container">
            <button id="contact-close-button" class="close-button">&times;</button>
            <h2 id="contact-title"></h2>
            <form id="contact-form" action="https://formspree.io/f/xbdajoag" method="POST">
                <label for="name" id="label-name"></label>
                <input type="text" id="name" name="name" required>

                <label for="email" id="label-email"></label>
                <input type="email" id="email" name="email" required>

                <label for="message" id="label-message"></label>
                <textarea id="message" name="message" rows="5" required></textarea>

                <button type="submit" id="contact-submit"></button>
            </form>
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script type="text/javascript">
        // More API functions here:
        // https://github.com/googlecreativelab/teachablemachine-community/tree/master/libraries/image

        // THE TEAHABLE MACHINE MODEL URL FOR ANIMAL FACE TEST
        // PLEASE REPLACE THIS WITH YOUR ACTUAL MODEL URL
        const URL = "https://teachablemachine.withgoogle.com/models/NUCdwV0FQ/"; 

        // 전역 변수들 선언 (DOMContentLoaded 내부에서도 접근 가능하도록)
        let model, maxPredictions; // 모델 및 예측 관련 변수
        let labelContainer; // 결과 라벨을 표시할 컨테이너
        let translations; // 번역 데이터
        let lastPredictedResult = { originalClassName: '', translatedClassName: '', description: '' };
        let imageCanvas; // 캔버스 요소
        let ctx; // 캔버스 컨텍스트
        let myConfetti; // Confetti 인스턴스


        document.addEventListener('DOMContentLoaded', async () => {
            // DOM 요소 참조 (DOMContentLoaded 내부에서 안전하게)
            imageCanvas = document.getElementById('image-canvas');
            ctx = imageCanvas.getContext('2d');

            const fileInput = document.getElementById('file-input');
            const startButton = document.getElementById('animal-face-test-start-button'); // 이제 button 요소
            const animalDescriptionDiv = document.getElementById('animal-description');
            const shareAnimalFaceButton = document.getElementById('share-animal-face-button'); 
            const loadingMessage = document.getElementById('loading-message'); // 로딩 메시지 요소 참조
            const backToHomeButton = document.getElementById('back-to-home-button'); // 홈으로 돌아가기 버튼 참조
            labelContainer = document.getElementById("label-container"); // 전역 변수에 할당

            startButton.addEventListener('click', () => {
                fileInput.click(); // 버튼 클릭 시 input type="file" 트리거
            });

            // Confetti setup - use the image-container as the origin for confetti
            myConfetti = confetti.create(document.getElementById('image-container'), {
                resize: true,
                useWorker: true
            });


            // Load the image model
            async function loadModel() {
                loadingMessage.style.display = 'block'; // 모델 로드 시작 시 메시지 표시
                startButton.disabled = true; // 모델 로드 중에는 버튼 비활성화
                try {
                    const modelURL = URL + "model.json";
                    const metadataURL = URL + "metadata.json";
                    model = await tmImage.load(modelURL, metadataURL);
                    maxPredictions = model.getTotalClasses();
                    startButton.style.display = 'block'; // 모델 로드 성공 시 버튼 표시
                    startButton.disabled = false; // 모델 로드 성공 시 버튼 활성화
                } catch (error) {
                    console.error("Failed to load Teachable Machine model:", error);
                    alert("Teachable Machine 모델을 로드하는 데 실패했습니다. 네트워크 연결을 확인하거나 나중에 다시 시도해 주세요."); // User-friendly error message
                    startButton.style.display = 'none'; // 모델 로드 실패 시 버튼 숨김
                } finally {
                    loadingMessage.style.display = 'none'; // 모델 로드 완료 (성공 또는 실패) 시 로딩 메시지 숨김
                }
            }

            // Function to predict from an image
            async function predict() {
                if (!model) {
                    console.error("Model not loaded.");
                    return;
                }
                const prediction = await model.predict(imageCanvas);
                let highestProbability = 0;
                let originalPredictedClassName = '';

                for (let i = 0; i < maxPredictions; i++) {
                    if (prediction[i].probability > highestProbability) {
                        highestProbability = prediction[i].probability;
                        originalPredictedClassName = prediction[i].className;
                    }
                }
                
                // Get current language and translations
                const currentLang = localStorage.getItem('lang') || 'ko';
                const translatedClassName = originalPredictedClassName; // 모델 출력이 이미 한글 라벨이므로 직접 사용
                const description = translations[currentLang].animalDescriptions[translatedClassName];

                labelContainer.innerHTML = '';
                const resultDiv = document.createElement("div");
                resultDiv.innerHTML = translatedClassName;
                labelContainer.appendChild(resultDiv);

                animalDescriptionDiv.textContent = description || '';
                
                lastPredictedResult = { 
                    originalClassName: originalPredictedClassName,
                    translatedClassName: translatedClassName,
                    description: description 
                };
                shareAnimalFaceButton.style.display = 'block';

                // Trigger confetti for "개상" (dog face)
                if (originalPredictedClassName === '개상') { // Original class name is '개상' based on metadata.json
                    myConfetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.6 }
                    });
                }
            }

            // --- 이벤트 리스너들 ---
            fileInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const img = new Image();
                    img.onload = async () => {
                        imageCanvas.width = 200;
                        imageCanvas.height = 200;
                        ctx.drawImage(img, 0, 0, 200, 200);
                        imageCanvas.style.display = 'block';
                        labelContainer.innerHTML = '';
                        animalDescriptionDiv.textContent = '';
                        shareAnimalFaceButton.style.display = 'none';
                        await predict();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });

            shareAnimalFaceButton.addEventListener('click', () => {
                const currentLang = localStorage.getItem('lang') || 'ko';
                const shareTextTemplate = translations[currentLang].shareAnimalFaceText;
                const shareText = shareTextTemplate
                    .replace('##RESULT##', lastPredictedResult.translatedClassName)
                    .replace('##DESCRIPTION##', lastPredictedResult.description);
                const shareUrl = 'https://www.instagram.com/';

                alert(`인스타그램에 공유해보세요!

${shareText}`);
                window.open(shareUrl, '_blank');
            });

            // backToHomeButton is removed, no event listener needed
            // backToHomeButton.addEventListener('click', () => {
            //     window.location.href = 'index.html';
            // });

            // --- 초기화 로직 ---
            startButton.style.display = 'none'; // 모델 로드 전에는 시작 버튼 숨김
            await loadModel(); // 모델 로드 시작

            // translations 변수에 할당
            translations = {
                ko: {
                    animalFaceTestTitle: '동물상 테스트',
                    animalFaceTestDescription: 'AI가 당신의 얼굴을 분석하여 어떤 동물상에 가까운지 알려드립니다. 사진을 업로드하여 당신의 동물상을 확인해보세요!',
                    aboutNavButton: '소개',
                    contactNavButton: '제휴 문의',
                    tmImageModel: 'Teachable Machine Image Model',
                    start: '이미지 업로드',
                    animalDescriptions: {
                        '고양이상': '당신은 도도하고 매력적인 고양이상입니다! 날카로운 듯 올라간 눈꼬리는 섹시함을, 오똑한 콧대는 자신감을 보여줍니다. 신비로운 분위기로 사람들의 시선을 사로잡으며, 독립적이고 자기 주관이 뚜렷합니다. 때로는 까칠해 보이지만, 마음을 열면 누구보다 따뜻한 매력을 발산합니다. 당신의 시크한 매력에 많은 사람들이 반할 것입니다!',
                        '개상': '당신은 충성스럽고 정이 많은 개상입니다! 크고 맑은 눈은 순수함을, 살짝 처진 눈꼬리는 온화함을 나타냅니다. 주변 사람들에게 편안함을 주며, 한번 마음 준 사람은 절대 배신하지 않는 의리의 상입니다. 긍정적이고 활발한 성격으로 어디서든 인기를 한 몸에 받습니다. 당신의 매력에 모두가 빠져들 거예요!',
                        '돼지상': '당신은 복스럽고 풍요로운 돼지상입니다! 둥글고 푸근한 인상은 재물운과 건강운을 동시에 상징합니다. 넉넉한 얼굴형은 사람들에게 편안함과 안정감을 주며, 먹을 복과 인복이 많아 항상 주변에 사람이 끊이지 않습니다. 낙천적이고 여유로운 성격으로 어떤 어려움도 현명하게 헤쳐나갑니다. 당신과 함께하는 모든 순간이 행복으로 가득 찰 거예요!'
                    },
                    shareAnimalFaceButton: '결과 공유하기',
                    shareAnimalFaceText: '방금 동물상 테스트에서 "##RESULT##" 동물상으로 나왔어요! ##DESCRIPTION##'
                },
                en: {
                    animalFaceTestTitle: 'Animal Face Test',
                    animalFaceTestDescription: 'The AI will analyze your face to tell you which animal you resemble. Upload your photo to find out your animal face!',
                    aboutNavButton: 'About',
                    contactNavButton: 'Contact',
                    tmImageModel: 'Teachable Machine Image Model',
                    start: 'Upload Image',
                    animalDescriptions: {
                        'Cat': 'Yours is a haughty and charming Cat Face! Sharply upturned eyes suggest sexiness, and a high nose bridge shows confidence. You captivate attention with your mysterious aura, being independent and opinionated. Though sometimes appearing prickly, you radiate warmth once you open up. Many will be smitten by your chic charm!',
                        'Dog': 'You have a loyal and affectionate Dog Face! Large, clear eyes signify purity, and slightly downturned eyes indicate gentleness. You bring comfort to those around you and never betray those you\'ve bonded with. Your positive and active personality makes you popular everywhere. Everyone will fall for your charm!',
                        'Pig': 'You possess a fortunate and prosperous Pig Face! Your round and amiable features symbolize both wealth and health. Your generous face shape brings comfort and stability to others, and you are blessed with good fortune in food and relationships. Your optimistic and relaxed nature allows you to wisely navigate any difficulties. Every moment with you will be filled with happiness!'
                    },
                    shareAnimalFaceButton: 'Share Result',
                    shareAnimalFaceText: 'My animal face reading result is "##RESULT##"! ##DESCRIPTION##'
                }
            };

            // Initial language setup
            const currentLang = localStorage.getItem('lang') || 'ko';
            document.title = translations[currentLang].animalFaceTestTitle;
            document.getElementById('animal-face-test-header').textContent = translations[currentLang].animalFaceTestTitle;
            document.getElementById('animal-face-test-description').textContent = translations[currentLang].animalFaceTestDescription;
            document.getElementById('animal-face-test-nav-button').textContent = translations[currentLang].animalFaceTestTitle; // Nav button text
            document.getElementById('about-nav-button').textContent = translations[currentLang].aboutNavButton;
            document.getElementById('contact-nav-button').textContent = translations[currentLang].contactNavButton;
            document.getElementById('tm-image-model-text').textContent = translations[currentLang].tmImageModel;
            startButton.textContent = translations[currentLang].start; // startButton 텍스트 설정
            shareAnimalFaceButton.textContent = translations[currentLang].shareAnimalFaceButton; // Set text for share button
        });
    </script>
    <script src="main.js"></script>
</body>
</html>